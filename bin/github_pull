#!/usr/bin/env python3
"""GitHub repositories sync script

This script accesses GitHub repositories via ssh and either clone or
pull the default branch to its head on remote.

Examples
--------

  $ github_pull <username or access_token> --root-dir <root_dir>

will sync all personally owned repos at
*<root_dir>/<login_name>/<repo_name>/*. When GitHub username is
provided instead of access token, you will be prompted for a
password. When omitted, <root_dir> defaults to the current directory.

You may also sync repos from an organization you belong to, e.g.,

  $ github_pull <username or access_token> --org <org>

where <org> is the organization login name.


Requirements
------------

Python packages: PyGithub


TODO
----

- Gracefully handle when checkout to the default branch cannot be done
  cleanly due to modified files.

"""
import getpass
import logging
import os
import sys
from argparse import ArgumentParser
from argparse import RawTextHelpFormatter
from dataclasses import dataclass
from subprocess import Popen

try:
    from github import Github
    from github.GithubException import GithubException
    from github.GithubException import BadCredentialsException
except ImportError:
    raise ImportError("Install the PyGithub package")

logging.basicConfig()
log = logging.getLogger(__name__)


CLONE_URL_FORMAT = "git@github.com:{login}/{repo}.git"


def sh(cmd):
    p = Popen(cmd, shell=True, stdout=sys.stdout, stderr=sys.stderr)
    stdout, stderr = p.communicate()
    return p.returncode


def get_user(username_or_token):
    try:
        g = Github(username_or_token)
        user = g.get_user()
        user.name  # to trigger authentication or fail
    except BadCredentialsException:
        password = getpass.getpass(prompt="Enter password: ")
        g = Github(username_or_token, password)
        user = g.get_user()
        try:
            user.name  # to trigger authentication or fail
        except GithubException as exc:
            if exc.status == 401:
                # onetime_password = getpass.getpass(prompt="Enter one-time password: ")
                print(list(user.get_authorizations()))

                # auth = user.create_authorization(
                #     scopes=["repo"], note="demo", onetime_password=onetime_password
                # )
                # print(auth.id)
                # print(user.name)
                # two-factor
                # raise Exception("twofactor")
            else:
                raise
        # print(user.create_authorization())
    return user


@dataclass
class RepoInfo:
    name: str
    login: str
    default_branch: str
    clone_url: str


def get_repos(username_or_token, org=None):
    user = get_user(username_or_token)
    if not org:
        for repo in user.get_repos(type="owner"):
            yield RepoInfo(
                repo.name,
                user.login,
                repo.default_branch,
                CLONE_URL_FORMAT.format(login=user.login, repo=repo.name),
            )
    else:
        for _org in user.get_orgs():
            if org == _org.login:
                break
        else:
            raise ValueError(f"{org} not found")

        for repo in _org.get_repos():
            yield RepoInfo(
                repo.name,
                _org.login,
                repo.default_branch,
                CLONE_URL_FORMAT.format(login=_org.login, repo=repo.name),
            )


def clone(repo, root_dir):
    path = os.path.join(root_dir, repo["login"])
    cmds = (
        "mkdir -p {path}; "
        "cd {path}; "
        'echo "In $(pwd)"; '
        "git clone {clone_url};  "
    ).format(path=path, **repo)
    retcode = sh(cmds)
    if retcode:
        raise Exception(stderr)


def pull(repo, root_dir):
    path = os.path.join(root_dir, repo["login"], repo["name"])
    cmds = (
        "cd {path}; "
        'echo "In $(pwd)"; '
        "git fetch; "
        "git checkout {default_branch}; "
        "git pull origin {default_branch};"
    ).format(path=path, **repo)
    retcode = sh(cmds)
    if retcode:
        raise Exception(stderr)


def main(username_or_token, root_dir, org):
    print(get_user(username_or_token))
    return
    for repo in get_repos(username_or_token=username_or_token, org=org):
        repo_dir = os.path.join(root_dir, repo["login"], repo["name"])

        if not os.path.exists(repo_dir):
            try:
                clone(repo, root_dir)
            except Exception:
                log.exception("Error cloning %s", repo["name"])
        else:
            if not os.path.isdir(repo_dir):
                raise IOError(
                    f"{repo_dir} is not a directory. Make sure it is a proper Git repo"
                )
            try:
                pull(repo, root_dir)
            except Exception:
                log.exception("Error pulling %s", repo["name"])


if __name__ == "__main__":
    p = ArgumentParser(description=__doc__, formatter_class=RawTextHelpFormatter)
    p.add_argument("username_or_token", help="GitHub username or access token")
    p.add_argument("--org", help="GitHub organization")
    p.add_argument(
        "--root-dir", default=".", help="root directory where local repos are cloned"
    )
    main(**vars(p.parse_args()))
