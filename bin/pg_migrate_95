#!/bin/bash
#
# Migrate from PostgreSQL 9.4 to 9.5 on Debian/Jessie
#
# It appears the stock PostgreSQL 9.4 remains running at port 5432,
# whereas newly installed 9.5 runs at port 5433.
#

PORT_OLD=5432  # version 9.4
PORT_NEW=5433  # version 9.5
DB_DUMP_DIR=/tmp/pgdb

readonly PORT_OLD
readonly PORT_NEW
readonly DB_DUMP_DIR

# The following would work for simple setting, but with PostGIS it
# will barf.

# sudo /etc/init.d/postgresql stop
# su postgres
# /usr/lib/postgresql/9.5/bin/pg_upgrade \
#   -b /usr/lib/postgresql/9.4/bin/ \
#   -B /usr/lib/postgresql/9.5/bin/ \
#   -d /var/lib/postgresql/9.4/main \
#   -D /var/lib/postgresql/9.5/main \
#   -o ' -c config_file=/etc/postgresql/9.4/main/postgresql.conf' \
#   -O ' -c config_file=/etc/postgresql/9.5/main/postgresql.conf'
# sudo /etc/init.d/postgresql start

# The following hard restores each database, taking care of PostGIS
# version difference.

sudo PORT_OLD="$PORT_OLD" PORT_NEW="$PORT_NEW" DB_DUMP_DIR="$DB_DUMP_DIR" \
     su postgres <<'EOF'
tmpdir="$DB_DUMP_DIR"
mkdir -p "$tmpdir"

pg_dumpall -p "$PORT_OLD" -U postgres -g -f "$tmpdir/_globals.backup"

psql -p "$PORT_NEW" -U postgres -f "$tmpdir/_globals.backup" \
  2> /tmp/errors._globals.log

databases=$(psql -p "$PORT_OLD" -Atc \
              "SELECT datname, rolname 
                 FROM pg_database
                 INNER JOIN pg_roles ON pg_database.datdba = pg_roles.oid
                 WHERE datistemplate = false ")
readonly databases
# echo ${databases[@]}

for row in ${databases[@]}; do
  db=$(echo "$row" | cut -d \| -f1)
  pg_dump -p "$PORT_OLD" -U postgres -Fc -b -v -f "$tmpdir/$db.backup" "$db"
done

for row in ${databases[@]}; do
  db=$(echo "$row" | cut -d \| -f1)
  role=$(echo "$row" | cut -d \| -f2)

  exists=$(psql -p "$PORT_NEW" -Atc \
             "SELECT datname FROM pg_database WHERE datname='$db'" |
             grep "^$db$")

  if [[ -z "$exists" ]]; then
    echo "$db does not exist"
    createdb -p "$PORT_NEW" -O "$role" "$db"
    /usr/share/postgresql/9.5/contrib/postgis-2.2/postgis_restore.pl \
      "$tmpdir/$db.backup" | \
      psql -p "$PORT_NEW" "$db" 2> /tmp/errors."$db".log
  else
    echo "$db exists"
  fi
done
EOF
